#include <list.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>

#define N 1000000

static struct list_head head = LIST_HEAD_INIT(head);

struct node {
	struct list_head list;
	int value;
	char content[600];
};

struct action {
	uint8_t type;
	uint8_t index;
};

/* This is a random pattern of actions */
static struct action const pattern[] = { {0, 0}, {0, 0}, {0, 0}, {0, 0}, {1, 0}, {1, 0}, {1, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {2, 1}, {2, 2}, {1, 0}, {1, 0}, {1, 0}, {1, 0}, {0, 0}, {0, 0}, {2, 5}, {0, 0}, {1, 0}, {0, 0}, {2, 7}, {2, 4}, {1, 0}, {0, 0}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {2, 3}, {0, 0}, {2, 6}, {0, 0}, {2, 9}, {1, 0}, {2, 8}, {0, 0}, {0, 0}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {1, 0}, {1, 0}, {2, 10}, {0, 0}, {1, 0}, {2, 11}, {1, 0}, {0, 0}, {2, 12}, {2, 13}, {0, 0}, {0, 0}, {0, 0}, {2, 14}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {2, 15}, {1, 0}, {1, 0}, {2, 16}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {2, 17}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {1, 0}, {1, 0}, {0, 0}, {1, 0}, {2, 18}, {2, 19}, {1, 0}, {2, 20}, {0, 0}, {0, 0}, {0, 0}, {1, 0}, {0, 0}, {1, 0}, {2, 21}, {1, 0}, {0, 0}, {2, 22}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {2, 23}, {0, 0}, {0, 0}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {0, 0}, {2, 24}, {0, 0}, {2, 25}, {2, 26}, {1, 0}, {1, 0}, {0, 0}, {0, 0}, {0, 0}, {1, 0}, {0, 0}, {2, 27}, {2, 28}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {2, 29}, {0, 0}, {0, 0}, {2, 30}, {2, 31}, {1, 0}, {2, 32}, {0, 0}, {1, 0}, {1, 0}, {0, 0}, {2, 33}, {2, 0}, {2, 34}, {0, 0}, {0, 0}, {0, 0}, {1, 0}, {0, 0}, {2, 35}, {1, 0}, {0, 0}, {2, 36}, {1, 0}, {1, 0}, {0, 0}, {0, 0}, {1, 0}, {2, 37}, {0, 0}, {2, 38}, {2, 39}, {0, 0}, {1, 0}, {0, 0}, {2, 40}, {1, 0}, {0, 0}, {0, 0}, {1, 0}, {1, 0}, {1, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {1, 0}, {1, 0}, {2, 41}, {0, 0}, {2, 42}, {0, 0}, {1, 0}, {0, 0}, {2, 43}, {0, 0}, {0, 0}, {2, 44}, {0, 0}, {1, 0}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {0, 0}, {2, 45}, {1, 0}, {0, 0}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {1, 0}, {0, 0}, {2, 46}, {2, 50}, {1, 0}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {2, 47}, {2, 48}, {1, 0}, {2, 49}, {2, 51}, {0, 0}, {0, 0}, {2, 52}, {0, 0}, {0, 0}, {0, 0}, {0, 0}, {1, 0}, {2, 57}, {0, 0}, {0, 0}, {2, 53}, {0, 0}, {0, 0}, {2, 54}, {0, 0}, {2, 55}, {0, 0}, {1, 0}, {0, 0}, {0, 0}, {2, 56}, {1, 0}, {2, 58}, {0, 0}, {0, 0}, {2, 60}, {0, 0} };

static inline struct node *node_add(struct list_head *list, int value)
{
	struct node *node = malloc(sizeof(*node));
	node->value = value;
	list_add(&node->list, list);
	return node;
}

static inline void node_del(struct node *node)
{
	list_del(&node->list);
	free(node);
}

void test(int times)
{
	struct node *stash[256];

	for (int round = 0; round < times; round++) {
		int stash_i = 0;
		for (int i = 0; i < 256; i++) {
			const struct action *action = &pattern[i];
			switch (action->type) {
			case 0:
				if (list_is_empty(&head)) continue;
				break;
			case 1:
				stash[stash_i++] = node_add(&head, round);
				break;
			case 2:
				node_del(stash[action->index]);
				break;
			}
		}
	}
}

int main(void)
{
	test(N);

	struct node *p;
	list_for_each_entry_safe(p, &head, list)
		free(p);

	return 0;
}
